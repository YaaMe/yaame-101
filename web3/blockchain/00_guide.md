# 导言

区块链的[历史](https://github.com/yeasy/blockchain_guide/blob/master/01_history/bitcoin.md)不想做过多赘述，感兴趣的自行翻阅吧，画饼的部分请自助消化……反正从bitcoin涉及的领域范围来讲，我更倾向于中本聪是一个匿名组织而不是人的推论。

## 什么是区块链

简单讲就是一个分布式单链表。

复杂一点点讲，block-1包含hash(block-0)的信息，同时依赖block-0的数据，block-2包含hash(block-1)的信息，同时依赖block-1的数据。场景简单点就转钱，每一个block只记录这一轮账目的转移情况。

比如古代有个小小的村落有一群猛男在愉快地捡树枝，这村子里每个人都有一个账本，只有相同的内容才会被大家认为是事实。

于是block-0法外狂徒张三在海边捡了100块贝壳（PoW），全村的人都看见了。

然后block-1张三给了暴徒李四70块贝壳，附张三的签名。

然后block-2李四给二愣子王五20块贝壳，附李四的签名。

你手里什么都没有，如果你要在block-3里写你也在海边捡到了100块贝壳，你得让全村的人看见，行不通。

你想伪造李四给了你50块贝壳，你需要攻破现有的非对称公私钥体系，拿到李四的私钥，这条路也行不通。

那么你只能伪造记录，你得去修改block-2的数据，而这样照理类推，你需要一直修改到创世区块。

那么接下来只需要确保数据源可信，这就涉及到各种 Proof-of-XXX 的证明机制了。这个在下面的篇章里讲。同样这里还有个双花问题，也先咕一咕。

## MECE分类

区块链本身作为一个分布式的账本数据库，从节点属性上分三种 私链/联盟链/公链。

私链：某人独立拥有全部的节点。此时的区块链就是一个单纯的分布式数据库，我也不知道有啥商业价值，区块链的主要价值之一是信用转移，即原本依赖于人的信用被通过数学转移到了一串hash值，而私链显然无法证明数据映射，信托背后依旧是个人或者中心集体，除非节点角色是个中间件，但中间件角色就可以玩成联盟链。定义上看测试链属于这种吧。额，可能还有现阶段的数字人民币。

联盟链：某几个人加起来拥有全部的节点。体感上政府项目更多，一般是不进公众视野的。这时候的联盟链有2种玩法：一种是将这些节点作为某个平台或者服务提供。另一种是不同的实体间相互制约验证用。这里由于不涉及公链，信用依旧由背后的实体担当，玩法会更多样一点，你可以声明各种节点的角色，你可以做信息不完全透明，只做部分数据验证，因为只需要确保数据不会被篡改，交易撮合要用的时候再互相验hash就行了。可以使用的场景其实很多，比如简历求职的信息，租房房源和租客的信息，各种供应链。当然这里面涉及商家利益，你要真能找到几家比如51和boss联合做这个，他们大概既没这个技术实力，也未必觉得能通过这个赚钱……至于政府项目就懂的都懂，混口饭吃……

公链：进入公众视野的一般是这个，因为面向每一个用户都可以独自做节点（但其实还是集中在少部分人手里，毕竟有钱就是可以这样为所欲为……）。bitcoin，ethereum，ipfs，但公链受到的制约会多很多，毕竟你不能相信任何一个节点，所以每一个节点都只能做相同的事情，这里还没有到合约的部分，单纯说节点，比如ipfs存文件就是存文件，你不能划一批节点存更高贵的文件……或者你不能像cdn那样划一个区域的节点只做边缘计算，不过你可以给节点设立角色自己选择，比如你是想提供cpu，还是提供存储，这个是可以的，但这取决于节点用户意愿，分布上属于听天由命的类型，而且目前来讲还没有看到那么复杂的设计，因为这里激励机制也会变得挺复杂的，公链的激励机制是个涉及社区运营的复杂玩意儿了，有点超出我的知识范围。


以实际案例理解来说，私链逃不开的一个问题是：我为啥不直接使用分布式数据库？相比而言优势在哪里？套在区块链定义上的这些在私链看来只会成为阻碍，所以基本上私链并不会以区块链的技术为卖点进行。cloudflare的cdn边缘计算方案有大量私链的影子（于是上手就用得很舒服），基本玩过合约开发的稍微有点后端开发和网络的基础就能很快理解并玩转这套玩意儿。

联盟链成立的一个前提是，牵涉其中的实例本身需要不是一个整体，否则没有意义。如cdn边缘计算的方案成为了某种公认协议，CF开始售卖/租用其边缘节点给其他的cdn厂商，比如你可以在cf的边缘worker上和同七牛的边缘节点数据互相调用，此时就可以将玩法转变为联盟链。这里面区块的数据你可以理解为cache存储的内容。

## CAP与矿工

作为一个分布式系统，区块链是怎么面对CAP问题的呢？分布式肯定是占了的，所以区块链妥协的是一致性和可用性，具体表现是每一个区块高度会以百分比增加数据可信度，每出一个块，区块存在的概率 * x%。

首先是数据源的可信度，最早先是工作量证明，矿工需要付出实际的算力成本，以上文的例子来讲，意味着你可能需要花费200贝壳的劳动力才能修改50贝壳。区块链只认块高，这意味着你需要拥有全网51%的算力才可以保证篡改结果，。这便是工作量证明（PoW）的思路，由于算力在全网是以百分比形式对抗，所以这里会有一个全网难度的概念，随着整体算力的增加，难度会增加，以此来维持出块的时间概率尽可能平稳，除非全网算力骤升骤降，那可能会有点问题。

PoW的问题是能源浪费，矿场卷嘛……所以后面冒出了PoS等一系列证明机制，PoS理解起来也很简单，我们找个钱多的做保障，如果有一天倒了反正他是最大的冤大头…DPoS么，就是我们找一群有钱人一起来做保障……是不是听着越来越不去中心化了？其实PoW也没区别，就像开头说的那样，算力资源其实还是集中在少数人手里，现实世界又何尝不是这样呢。

哦，PoW当中还冒出过一次33%算力攻击，这事解释起来也简单，林子大了嘛，fork一份bitcoin的代码起家割韭菜的人就多了，贪婪的矿工干了一件很聪明的事情：由于代码都是同一份，它们会判断挖哪个币的收益最高，然后会自动把算力切过去……之前说了，全网算力骤升骤降是会有风险的，于是只要你持有足够量，大约三分之一的算力时，你就可以通过切换算力网的方式完成攻击。于是在聪明的人类社会工程下，你成功达成了用更少的算力完成全网攻击的成就。不过嘛，你要学会相信最终算力还是会被掌握在少数人手里。

回到CAP问题，我在上文其实已经给出了第一种攻击手段（当然这需要你比较有钱 (♯｀∧´) ），由此你大概可以明白首个区块的可信度是相当低的，随时有可能因为算力切换而一下子连出两个块，全网算力的调整是需要时间的，分布式嘛。除此之外还有一个典型问题：双花。

基于No1区块我有50块钱，No2区块我可以同时向2个节点发去2笔交易，A: 我花了40块钱，B: 我花了30块钱。很显然从一致性数据上我们可以得知账目是不够的交易是无法完成的，但我们可以足够狡猾，将交易发送到相隔比较远的两个节点上去，它们互相同步区块需要时间，很可能它们拉到对方的数据时，区块已经出了2个。此时很显然，这两条链的数据是冲突的，这时候会构成竞争关系，原理之前就说了，节点只承认区块高度更高的块。所以其中一个节点的区块数据会被废弃掉，因此你其中的一笔交易会被否认并从区块中被扔掉（甚至可能仅仅在交易池中还没被挑选进块）。于是就造成了你可能会在一个区块中看到了其中某一笔交易，过一阵子就不见了，区块链上的交易需要等待交易确认，等待的就是块高。这里需要注意一点，一般区块链在发送交易时，是需要给而且即便如此，节点的矿工比较倒霉，矿工需要先完成计算，然后挑选交易打包成区块并声明计算结果，在交易打包时，贪婪的矿工显然会选择交易奖励较高的交易优先确认，于是你可以大方地给某人打去40块钱，然后立即给自己另一个钱包打11块钱过去，用更高的手续费优先否掉40块钱的那笔交易，当然，可怜的矿工显然是不知道哪些交易是被双花的，手慢了还是有可能让后面那笔交易失败的……

另一种攻击你可能听过很多的叫做拜占庭容错，简单来说就是节点故意给错误数据，这也是个常见的分布式容错方案，遵循1/3节点可用的前提进行多数决即可。注意这几种攻击手段都跟合约和网络没有关系。所以区块链在一致性和可用性间做了妥协，你要数据一致，那就要等待块高，你要可用，就要接受数据可能消失的风险。这里最有意思的事情其实是，合约交易由于是跑在区块上的，所以合约上的代码永远是安全的，它不用担心数据突然没了，因为区块要回滚它数据反正跟着一起回滚的，但基于合约事件/或者你可以认为是某种webhook，架设的外部服务群就未必了，所以围绕智能合约搭建应用体系的时候，你需要思考什么样的功能需要在合约上，什么样的功能得在链外。

双花这里还有个简单的分支小问题：那我花40块和1块行吗？这得分情况，bitcoin和ethereum是两种地址体系。bitcoin使用的是utxo，交易必需撕毁原本的utxo然后创造等值的utxos，所以一个utxo只能被撕一次，以太更像现在的银行账户模型，每一笔交易本身都有个签名，以太的签名会有个nonce，即序号12345，以太取决于你用的是不是同一个nonce，总之以太来讲，如果你是同一个nonce，那不行，如果你用的是不同nonce，意味着这2是本身就有先后次序的两笔交易，那可以完成，因为交易都能在交易池里被找到。交易池没进区块甚至签完名不公开这个特性，发展出了lightning，雷电网络的技术……（坏了，要后面解释的东西越来越多了）

那么下回书我们就讲讲区块链两种主流地址体系和公私钥。
